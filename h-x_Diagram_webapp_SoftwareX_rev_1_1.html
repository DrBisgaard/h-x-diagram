% Mollier h-x WebApp Diagram v. 1.1.0 

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Absolute Humidity, Relative Humidity & Entropy</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body style="font-family: sans-serif; padding: 20px;">

<h2>Absolute Humidity, Relative Humidity & Entropy Webapp</h2>

<label>Temperature (°C): <span id="tempVal">30</span>°C</label><br>
<input type="range" id="temperature" min="-20" max="45" value="30" step="0.5" style="width: 300px;"><br><br>

<label>Relative Humidity (% RH): <span id="rhVal">60</span>%</label><br>
<input type="range" id="rh" min="0" max="100" value="60" step="1" style="width: 300px;"><br><br>

<label>Absolute Humidity (g/kg): <span id="ahVal">--</span></label><br>
<input type="range" id="ah" min="0" max="65" value="14" step="0.1" style="width: 300px;"><br><br>

<label>Altitude (m ASL): <span id="altVal">0</span> m</label><br>
<input type="range" id="altitude" min="-500" max="5000" value="0" step="10" style="width: 300px;"><br><br>

<p><strong>Pressure:</strong> <span id="pVal">101.3</span> kPa</p>
<p><strong>Dew point:</strong> <span id="dewpointVal">--</span> °C</p>
<p><strong>Specific enthalpy (h):</strong> <span id="enthalpyVal">--</span> kJ/kg</p>
<p><strong>Specific entropy (s):</strong> <span id="entropyVal">--</span> kJ/kgK</p>

<div id="plot" style="width:100%;max-width:800px;height:1000px;"></div>

<hr style="margin-top: 40px;">
<p style="text-align: center; font-size: 0.9em; color: #666;">&copy; 2025 Dr Kenneth Bisgaard Christensen</p>

<script>
    // --- Constants for barometric formula (valid up to ~11 km, standard atmosphere) ---
    const P0 = 101325;        // sea-level standard pressure [Pa]
    const T0 = 288.15;        // sea-level standard temperature [K]
    const g = 9.80665;        // gravity [m/s^2]
    const L = 0.0065;         // temperature lapse rate [K/m]
    const R = 8.3144598;      // universal gas constant [J/(mol·K)]
    const M = 0.0289644;      // molar mass of Earth's air [kg/mol]
    const EXP = (g * M) / (R * L); // ≈ 5.25588

    // Thermo constants (kJ/kg-K)
    const c_pa = 1.006;   // dry air
    const c_pv = 1.86;    // water vapor
    const R_da = 0.287042; // dry air
    const R_v  = 0.46152;  // water vapor

    // Reference state for entropy (commonly used simple reference)
    const T_ref = 273.15;    // K (0 °C)
    const p_ref_da = 101325; // Pa (1 atm)
    const p_ref_w  = 611.21; // Pa (water saturation pressure at 0 °C)

    function pressureFromAltitude(h_m) {
        // Tropospheric barometric formula (non-isothermal)
        // P = P0 * (1 - (L * h)/T0)^(g*M/(R*L))
        const term = 1 - (L * h_m) / T0;
        if (term <= 0) return 0;
        return P0 * Math.pow(term, EXP);
    }

    // Saturation vapor pressure over water (Tetens-like; T in °C; returns Pa)
    function psat(T) {
        return 610.50 * Math.exp((17.269 * T) / (T + 237.3));
    }

    function dewpoint(T, RH) {
        const a = 17.269;
        const b = 237.3;
        const alpha = ((a * T) / (b + T)) + Math.log(RH / 100);
        return (b * alpha) / (a - alpha);
    }

    // Moist air enthalpy (approx.): h = 1.006*T + x*(2501 + 1.86*T) [kJ/kg dry air], T in °C, x in g/kg
    function enthalpy(T, x_g_per_kg) {
        const x = x_g_per_kg / 1000; // kg/kg
        return 1.006 * T + x * (2501 + 1.86 * T);
    }

    // Moist air specific entropy relative to (T_ref, p_ref_da, p_ref_w)
    // Inputs: T in °C, P in Pa, RH in %, AH in g/kg
    // Output: s in kJ/(kg dry air·K)
    function entropy(T_C, P, RH_percent, AH_gkg) {
        const T = T_C + 273.15;  // K
        const x = AH_gkg / 1000; // kg/kg (humidity ratio)
        const p_ws = psat(T_C);  // Pa
        const p_w = Math.min((RH_percent / 100) * p_ws, 0.9999 * P); // Pa (cap for safety)
        const p_da = Math.max(P - p_w, 1.0); // Pa

        // Ideal-mixture approximation per kg dry air
        const s_da = c_pa * Math.log(T / T_ref) - R_da * Math.log(p_da / p_ref_da);
        const s_wv = c_pv * Math.log(T / T_ref) - R_v  * Math.log((p_w <= 0 ? 1.0 : p_w) / p_ref_w);
        return s_da + x * s_wv;
    }

    let lastChanged = "rh";

    function updateSliders() {
        const T = parseFloat(document.getElementById("temperature").value);
        const RH = parseFloat(document.getElementById("rh").value);
        const AH = parseFloat(document.getElementById("ah").value);
        const h = parseFloat(document.getElementById("altitude").value);

        // Compute pressure from altitude
        const P = pressureFromAltitude(h); // Pa
        document.getElementById("pVal").innerText = (P / 1000).toFixed(1);
        document.getElementById("altVal").innerText = h.toFixed(0);

        const p_ws = psat(T);

        if (lastChanged === "rh") {
            const p_w = (RH / 100) * p_ws;
            const x = 0.622 * p_w / (P - p_w) * 1000; // g/kg
            document.getElementById("ah").value = x;
            document.getElementById("ahVal").innerText = x.toFixed(1);
        } else if (lastChanged === "ah") {
            const x = AH / 1000; // kg/kg
            const p_w = (x * P) / (0.622 + x);
            const rh_calc = (p_w / p_ws) * 100;
            document.getElementById("rh").value = rh_calc;
            document.getElementById("rhVal").innerText = rh_calc.toFixed(0);
        }

        document.getElementById("dewpointVal").innerText = dewpoint(T, RH).toFixed(1);
        document.getElementById("enthalpyVal").innerText = enthalpy(T, AH).toFixed(1);
        document.getElementById("entropyVal").innerText = entropy(T, P, RH, AH).toFixed(4);
    }

    function updatePlot() {
        const T_point = parseFloat(document.getElementById("temperature").value);
        const RH_point = parseFloat(document.getElementById("rh").value);
        const AH_point = parseFloat(document.getElementById("ah").value);
        const h = parseFloat(document.getElementById("altitude").value);
        const P = pressureFromAltitude(h); // Pa

        document.getElementById("tempVal").innerText = T_point;
        document.getElementById("rhVal").innerText = RH_point.toFixed(0);
        document.getElementById("ahVal").innerText = AH_point.toFixed(1);
        document.getElementById("dewpointVal").innerText = dewpoint(T_point, RH_point).toFixed(1);
        document.getElementById("enthalpyVal").innerText = enthalpy(T_point, AH_point).toFixed(1);
        document.getElementById("entropyVal").innerText = entropy(T_point, P, RH_point, AH_point).toFixed(4);
        document.getElementById("pVal").innerText = (P / 1000).toFixed(1);

        // Build psychrometric curves
        const Tdb = Array.from({length: 500}, (_, i) => -50 + i * (190 / 499));
        const x_s_gkg = Tdb.map(T => {
            const p_ws = psat(T);
            const x = 0.622 * p_ws / (P - p_ws);
            return x * 1000;
        });

        const p_ws_point = psat(T_point);
        const x_sat = 0.622 * p_ws_point / (P - p_ws_point) * 1000;
        const p_w_unsat = (RH_point / 100) * p_ws_point;
        const x_unsat = 0.622 * p_w_unsat / (P - p_w_unsat) * 1000;

        const trace1 = {
            x: x_s_gkg.filter((_, i) => Tdb[i] < 100),
            y: Tdb.filter(T => T < 100),
            mode: 'lines',
            name: '100% RH (saturation)',
            line: {color: 'blue'}
        };

        function generateRHcurve(rhPercent) {
            const x_rh = Tdb.map(T => {
                const p_ws = psat(T);
                const p_w = (rhPercent / 100) * p_ws;
                const x = 0.622 * p_w / (P - p_w);
                return x * 1000;
            });
            return {
                x: x_rh.filter((_, i) => Tdb[i] < 100),
                y: Tdb.filter(T => T < 100),
                mode: 'lines',
                name: `${rhPercent}% RH`,
                line: {dash: 'dot', width: 1.5, color: rhPercent === 40 ? 'green' : 'orange'}
            };
        }

        const trace40 = generateRHcurve(40);
        const trace60 = generateRHcurve(60);

        const trace2 = {
            x: [x_sat],
            y: [T_point],
            mode: 'markers+text',
            name: '100% RH point',
            text: [`${T_point.toFixed(1)} °C<br>${x_sat.toFixed(1)} g/kg`],
            textposition: 'top right',
            marker: {color: 'red', size: 10}
        };

        const trace3 = {
            x: [x_unsat],
            y: [T_point],
            mode: 'markers+text',
            name: `${RH_point.toFixed(0)}% RH point`,
            text: [`${T_point.toFixed(1)} °C<br>${x_unsat.toFixed(1)} g/kg`],
            textposition: 'bottom right',
            marker: {color: 'black', size: 10}
        };

        const trace4 = {
            x: [x_unsat],
            y: [dewpoint(T_point, RH_point)],
            mode: 'markers+text',
            name: 'Dew point',
            text: [`Dew point: ${dewpoint(T_point, RH_point).toFixed(1)} °C`],
            textposition: 'middle left',
            marker: {color: 'purple', size: 10, symbol: 'diamond'}
        };

        const trace5 = {
            x: [x_unsat],
            y: [-10],
            mode: 'text',
            name: 'Enthalpy',
            text: [`h: ${enthalpy(T_point, AH_point).toFixed(1)} kJ/kg`],
            textposition: 'bottom center',
            textfont: {color: 'brown', size: 12}
        };

        const trace6 = {
            x: [x_unsat],
            y: [-15],
            mode: 'text',
            name: 'Entropy',
            text: [`s: ${entropy(T_point, P, RH_point, AH_point).toFixed(4)} kJ/kgK`],
            textposition: 'bottom center',
            textfont: {color: 'teal', size: 12}
        };

        const layout = {
            xaxis: {title: 'Absolute humidity [g/kg]', range: [-25, 100], dtick: 25},
            yaxis: {title: 'Temperature [°C]', range: [-20, 60], dtick: 5},
            title: `Absolute humidity for saturated and unsaturated air (P ≈ ${(P/1000).toFixed(1)} kPa at ${h.toFixed(0)} m)`,
            legend: {x: 1.05, y: 1, xanchor: 'left', yanchor: 'top'}
        };

        Plotly.newPlot('plot', [trace1, trace40, trace60, trace2, trace3, trace4, trace5, trace6], layout);
    }

    // Event listeners
    document.getElementById("temperature").addEventListener("input", () => { updateSliders(); updatePlot(); });
    document.getElementById("rh").addEventListener("input", () => { lastChanged = "rh"; updateSliders(); updatePlot(); });
    document.getElementById("ah").addEventListener("input", () => { lastChanged = "ah"; updateSliders(); updatePlot(); });
    document.getElementById("altitude").addEventListener("input", () => { updateSliders(); updatePlot(); });

    // Initial render
    updateSliders();
    updatePlot();
</script>

</body>
</html>
